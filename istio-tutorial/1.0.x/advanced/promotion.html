<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Istio for Promoting Services (Feature Graduation) :: Istio Tutorial Docs</title>
    <link rel="canonical" href="https://rafabene.com/istio-tutorial/istio-tutorial/1.2.x/index.html">
    <meta name="generator" content="Antora 2.0.0">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="#">Istio Tutorial</a>
        <span class="separator">//</span>
        <a href="https://rafabene.com/istio-tutorial">Docs</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Project</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>GitHub</strong></div>
            <a class="navbar-item" href="https://github.com/rafabene/istio-tutorial">Istio Tutorial Repository</a>
            <a class="navbar-item" href="https://github.com/rafabene/istio-tutorial/issues">Istio Tutorial Issue Tracker</a>
          </div>
        </div>
        <a class="navbar-item" href="https://twitter.com/rafabene">
          <span class="icon">
            <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <path fill="#57aaee" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="istio-tutorial" data-version="1.0.x">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Istio Tutorial</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Introduction to Istio Tutorial</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../1setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../1setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../1setup.html#minishift">Setup MiniShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../1setup.html#environment">Setup Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../1setup.html#istioinstallation">Install Istio</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../2deploy-microservices.html">2. Deploy Microservices</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#deploycustomer">Deploy Customer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#deploypreference">Deploy Preference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#deployrecommendation">Deploy Recommendation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../2deploy-microservices.html#redeployingcode">Updating Redeploying Code</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../3monitoring-tracing.html">3. Observability</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../3monitoring-tracing.html#monitoring">Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../3monitoring-tracing.html#custommetrics">Custom Metrics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../3monitoring-tracing.html#tracing">Tracing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">4. Traffic Control</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../4simple-routerules.html">Simple Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4simple-routerules.html#deployrecommendationv2">Create Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../4simple-routerules.html#istiorouting">Changing Istio Routings</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv2">All Users To Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv1">All Users To Recommendation V1</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#alltorecommendationv1v2">All Users To Recommendation V1 and V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4simple-routerules.html#canarydeploymentrecommendation">Canary Deployment Between v1 And v2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../4advanced-routerules.html">Advanced Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../4advanced-routerules.html#canarydeploymentuseragent">Canary Deployment based on user-agent</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#alltorecommendationv1">All Users To Recommendation V1</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#safaritov2">All Safari Users To Recommendation V2</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../4advanced-routerules.html#mobiletov2">All Mobile Users To Recommendation V2</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4advanced-routerules.html#mirroringtraffic">Mirroring Traffic</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../4advanced-routerules.html#loadbalancer">Load Balancer</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../5circuit-breaker.html">5. Service Resiliency</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../5circuit-breaker.html#retry">Retry</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../5circuit-breaker.html#timeout">Timeout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../5circuit-breaker.html#failfast">Fail Fast</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#nocircuitbreaker">No Circuit Breaker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#circuitbreaker">Circuit Breaker</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../5circuit-breaker.html#poolejection">Pool Ejection</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#nofailinginstances">No Failing Instance</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#failinginstancesnopoolejection">Failing Instance No Pool Ejection</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../5circuit-breaker.html#failinginstancespoolejection">Failing Instance Pool Ejection</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../5circuit-breaker.html#circuitbreakerandpoolejection">Circuit Breaker + Pool Ejection</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../6fault-injection.html">6. Chaos Testing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../6fault-injection.html#503error">HTTP 503 Error</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../6fault-injection.html#delay">Delay</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../7policy.html">7. Policy</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../7policy.html#ratelimiting">Rate Limiting</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">8. Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8egress.html">Egress</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8egress.html#createrecommendationv3">Create Recommendation V3</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8egress.html#istioegress">Istio-ize Egress</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8acl.html">Access Control List</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8acl.html#whitelist">White List</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8acl.html#blacklist">Black List</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8mTLS.html">Mutual TLS and Istio</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8mTLS.html#preparation">Preparation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8mTLS.html#enablingtls">Enabling TLS</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8mTLS.html#restore">Restore Environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8jwt.html">End-user authentication with JWT</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8jwt.html#preparation">Preparation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8jwt.html#enablingauthentication">Enabling end-user authentication</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8jwt.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../8rbac.html">Istio Role Based Access Control (RBAC)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#enabling-rbac">Enabling RBAC</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#grant-access">Granting Access</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#authorization-jwt">Authorization and JWT</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#final-notes">Final Notes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../8rbac.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../9tips.html">10. Tips And Tricks</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Advanced Istio Tutorial</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="kiali.html">Kiali</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="kiali.html#howkiali">How Kiali Work</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="kiali.html#installkiali">Install Kiali</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="kiali.html#generatingdata">Generating Data</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="kiali.html#servicegraph">Service Graph</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="kiali.html#servicelistening">Service Listening</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="kiali.html#istioconf">Istio Config</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="kiali.html#distributedtracing">Distributed Tracing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="kiali.html#cleanup">Uninstall Kiali</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="virtualization.html">Service Virtualization and Istio</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="virtualization.html#deploypreferencev2">Deploy Preference V2</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="virtualization.html#servicevirtualization">Adding Service Virtualization</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="virtualization.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="diferencia.html">Diferencia and Detecting Regressions</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="diferencia.html#what-is-diferencia">What is Diferencia?</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="diferencia.html#master-candidate">Setting Master Candidate</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="diferencia.html#deploying-diferencia">Deploying Diferencia</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="diferencia.html#shadowing-traffic">Shadowing Traffic</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="diferencia.html#noise-detection">Noise Detection</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="diferencia.html#cleanup">Clean up</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="promotion.html">Istio for Promoting Services</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#what-is-promotion">What is Promotion?</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#deploy-recommendation-v3">Deploy Recommendation V3</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#feature-graduation]">Feature Graduation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="zero-downtime-database.html">Zero Downtime Migration with Database</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Starting the Migration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="zero-downtime-database.html#recommendationv4">Deploy Recommendation V4</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="zero-downtime-database.html#recommendationv5">Deploy Recommendation V5</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="zero-downtime-database.html#recommendationv6">Deploy Recommendation V6</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="zero-downtime-database.html#recommendationv7">Deploy Recommendation V7</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="zero-downtime-database.html#finalstep">Final Step</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="zero-downtime-database.html#cleanup">Clean Up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="cube.html">Dark Launch Automatic Test</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cube.html#preparation">Preparation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cube.html#explanation">Explanation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cube.html#code">Source Code</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cube.html#restore">Restore Environment</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Istio Tutorial</span>
    <span class="version">1.0.x</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Istio Tutorial</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../1.2.x/index.html">1.2.x</a>
        </li>
        <li class="version">
          <a href="../../1.1.x/index.html">1.1.x</a>
        </li>
        <li class="version is-current">
          <a href="../index.html">1.0.x</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main role="main">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../1.2.x/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Istio Tutorial</a></li>
    <li><a href="index.html">Advanced Istio Tutorial</a></li>
    <li><a href="promotion.html">Istio for Promoting Services</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">1.0.x</button>
  <div class="version-menu">
    <a class="version is-missing" href="../../1.2.x/index.html">1.2.x</a>
    <a class="version" href="../../1.1.x/advanced/promotion.html">1.1.x</a>
    <a class="version is-current" href="promotion.html">1.0.x</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/rafabene/istio-tutorial/blob/1.0.x/documentation/modules/advanced/pages/promotion.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1 class="page">Istio for Promoting Services (Feature Graduation)</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Before Start</div>
<div class="paragraph">
<p>You should have NO virtualservice, destinationrule, gateway or policy (in <code>tutorial</code> namespace) <code>istioctl get virtualservice</code> <code>istioctl get destinationrule</code> <code>istioctl get gateway</code> <code>istioctl get policy</code>
if so run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./scripts/clean.sh</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this chapter, we are going to see how to use Istio to promote a service to a more wide amount of users depending on their configuration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-promotion"><a class="anchor" href="#what-is-promotion"></a>What is a Service Promotion?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The idea behind service promotion is that you are able to promote your different versions of a service so it can be reached gradually by your public traffic.</p>
</div>
<div class="paragraph">
<p>What you define is different levels where your service is promoted, and in each of this level, the service is meant to be more stable than in the previous one.
You can think about graduating services to classes of users.</p>
</div>
<div class="paragraph">
<p>There are several ways of doing it, but one way we are using in <a href="http://www.openshift.io">OpenShift IO</a> is by allowing the user to choose if he wants to try the latest deployed version of the application (experimental level) or a stable version of the application (stable level).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/promotion-osio.png" alt="Features opt-in in OpenShift IO">
</div>
</div>
<div class="paragraph">
<p>This means that in the public cluster you have more than one version of the same service deployed, and the public traffic is able to reach it as well.</p>
</div>
<div class="paragraph">
<p>So let&#8217;s see how to implement this approach using Istio.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-recommendation-v3"><a class="anchor" href="#deploy-recommendation-v3"></a>Create recommendation:v3</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You need to be sure that you do not have a <em>recommendation:v3</em> deployed in the cluster and that <em>recommendation</em> code base is correct.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods
or
kubectl get pods

NAME                                  READY     STATUS    RESTARTS   AGE
customer-3600192384-fpljb             2/2       Running   0          17m
preference-243057078-8c5hz           2/2       Running   0          15m
recommendation-v1-60483540-9snd9     2/2       Running   0          12m
recommendation-v2-2815683430-vpx4p   2/2       Running   0         15s</code></pre>
</div>
</div>
<div class="paragraph">
<p>To check if <em>recommendation</em> source code is correct check that <code>getNow</code> method is not active.</p>
</div>
<div class="listingblock">
<div class="title">recommendation/java/vertx/src/main/java/com/redhat/developer/demos/recommendation/RecommendationVerticle.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        router.get("/").handler(this::getRecommendations);
//        router.get("/").handler(this::getNow);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You might have a <em>recommendation:v3</em> deployed because of you did <a href="../8egress.html" class="page">Egress Section</a> ad not cleaned up the resources.</p>
</div>
<div class="paragraph">
<p>If it is the case you can follow the <a href="../8egress.html#cleanup" class="page">Egress Clean Up Section</a>.</p>
</div>
<div class="paragraph">
<p>If it is not the case then run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete all -l app=recommendation,version=v3
or
kubectl delete all -l app=recommendation,version=v3</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can experiment with Istio controlling traffic by making a change to <code>RecommendationVerticle.java</code> like the following and creating a "v3" docker image.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private static final String RESPONSE_STRING_FORMAT = "recommendation v3 from '%s': %d\n";</code></pre>
</div>
</div>
<div class="paragraph">
<p>The "v3" tag during the Docker build is significant.</p>
</div>
<div class="paragraph">
<p>There is also a second <code>deployment.yml</code> file to label things correctly</p>
</div>
<div class="sect2">
<h3 id="_docker_build_if_you_have_access_to_docker_daemon"><a class="anchor" href="#_docker_build_if_you_have_access_to_docker_daemon"></a>Docker build (if you have access to Docker daemon)</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd recommendation/java/vertx
mvn clean package

docker build -t example/recommendation:v3 .

docker images | grep recommendation
example/recommendation                  v3                  c31e399a9628        1 seconds ago      438MB
example/recommendation                  v2                  c31e399a9628        5 seconds ago      438MB
example/recommendation                  v1                  f072978d9cf6        8 minutes ago      438MB</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
We have a 3rd Deployment to manage the v3 version of recommendation.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/recommendation/kubernetes/Deployment-v3.yml">../../kubernetes/Deployment-v3.yml</a>) -n tutorial
oc get pods -w -n tutorial

or

kubectl apply -f &lt;(istioctl kube-inject -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/recommendation/kubernetes/Deployment-v3.yml">../../kubernetes/Deployment-v3.yml</a>) -n tutorial
kubectl get pods -w -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_openshift_s2i_strategy_if_you_dont_have_access_to_docker_daemon"><a class="anchor" href="#_openshift_s2i_strategy_if_you_dont_have_access_to_docker_daemon"></a>OpenShift S2I strategy (if you DON&#8217;T have access to Docker daemon)</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn clean package -f recommendation/java/vertx
oc new-app -l app=recommendation,version=v3 --name=recommendation-v3 --context-dir=recommendation/java/vertx -e JAEGER_SERVICE_NAME=recommendation JAEGER_ENDPOINT=http://jaeger-collector.istio-system.svc:14268/api/traces JAEGER_PROPAGATION=b3 JAEGER_SAMPLER_TYPE=const JAEGER_SAMPLER_PARAM=1 JAVA_OPTIONS='-Xms128m -Xmx256m -Djava.net.preferIPv4Stack=true' fabric8/s2i-java~https://github.com/redhat-developer-demos/istio-tutorial -o yaml  &gt; recommendation-v3.yml
oc apply -f &lt;(istioctl kube-inject -f recommendation-v3.yml) -n tutorial
oc cancel-build bc/recommendation-v3 -n tutorial
oc delete svc/recommendation-v3 -n tutorial
oc start-build recommendation-v3 --from-dir=. --follow -n tutorial</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_wait_for_v3_to_be_deployed"><a class="anchor" href="#_wait_for_v3_to_be_deployed"></a>Wait for v3 to be deployed</h3>
<div class="paragraph">
<p>Wait for those pods to show "2/2", the istio-proxy/envoy sidecar is part of that pod.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                  READY     STATUS    RESTARTS   AGE
customer-3600192384-fpljb             2/2       Running   0          17m
preference-243057078-8c5hz           2/2       Running   0          15m
recommendation-v1-60483540-9snd9     2/2       Running   0          12m
recommendation-v2-2815683430-vpx4p   2/2       Running   0         15s
recommendation-v3-9834632434-urd34   2/2       Running   0         15s</code></pre>
</div>
</div>
<div class="paragraph">
<p>and test the customer endpoint until you can see that v3 has been reached.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl customer-tutorial.$(minishift ip).nip.io</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="feature-graduation"><a class="anchor" href="#feature-graduation"></a>Feature Graduation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With 3 versions of service <em>recommendation</em> deployed, now we can define 3 different level of access.
For example <em>experimental</em>, <em>beta</em> and <em>production</em>.</p>
</div>
<div class="paragraph">
<p>With Istio, we can use routing for sending traffic depending on users configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/istiofiles/destination-rule-recommendation-v1-v2-v3.yml">istiofiles/destination-rule-recommendation-v1-v2-v3.yml</a> -n tutorial
istioctl create -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/istiofiles/virtual-service-promotion-v1-v2-v3.yml">istiofiles/virtual-service-promotion-v1-v2-v3.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we need to set a header named <code>user-preference</code> with some specific value:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">For version 3</dt>
<dd>
<p><code>123</code> (<em>experimental</em>)</p>
</dd>
<dt class="hdlist1">For version 2</dt>
<dd>
<p><code>12</code> (<em>beta</em>)</p>
</dd>
<dt class="hdlist1">For version 1</dt>
<dd>
<p><em>empty</em> (<em>production</em>)</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The reason behind using these approach is the next one.
In this example, we have three levels <em>experimental</em>, <em>beta</em> and <em>production</em>, and we set a number to each level, 3 is the most unstable version while one is the most stable version.</p>
</div>
<div class="paragraph">
<p>So, for example, a user that sets its preferences to <em>experimental</em> it means that he needs to reach <em>experimental</em> or if no <em>eperimental</em> then <em>_beta</em> or by default <em>production</em>.
This effectively means setting that he wants to reach all levels <code>123</code>.
And the same applies to any other level defined by the user.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -H "user-preference: 123" customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v3 from '6953441398-tyw25': 1

curl -H "user-preference: 12" customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v2 from '3490080923-usw67': 2

curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v1 from '9834514598-knc40': 10</code></pre>
</div>
</div>
<div class="paragraph">
<p>One interesting point here is that if you open <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/istiofiles/virtual-service-promotion-v1-v2-v3.yml">istiofiles/virtual-service-promotion-v1-v2-v3.yml</a> you&#8217;ll see that the header is set to <code>baggage-user-preference</code> meanwhile in <code>curl</code> it is set to <code>user-preference</code>.</p>
</div>
<div class="paragraph">
<p>The reason is that in <em>customer</em> service (<a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/master/customer/java/springboot/src/main/java/com/redhat/developer/demos/customer/CustomerController.java#L35">CustomerController.java</a>), <code>io.opentracing.Tracer</code> class is used to set as baggage item the <code>user-preference</code> header.
In this way, the header is populated across all services without having to copy it manually in each service, since by default headers are not populated automatically.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s make a promotion of the versions, so <em>version 1</em> is not reachable anymore, <em>version 2</em> is the new <em>production</em> and <em>version 3</em> is the new <em>beta</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">istioctl replace -f <a href="https://github.com/redhat-developer-demos/istio-tutorial/blob/master/istiofiles/virtual-service-promoted-v3.yml">istiofiles/virtual-service-promoted-v3.yml</a> -n tutorial</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -H "user-preference: 123" customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v3 from '6953441398-tyw25': 2

curl -H "user-preference: 12" customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v3 from '6953441398-tyw25': 3

curl customer-tutorial.$(minishift ip).nip.io
customer =&gt; preference =&gt; recommendation v2 from '3490080923-usw67': 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that now the request with preference set to <em>experimental</em> falls back to <em>beta</em> as there is no <em>experimental</em> version.</p>
</div>
<div class="paragraph">
<p>So versions of a service are promoted without having to redeploy anything nor changing your code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cleanup"><a class="anchor" href="#cleanup"></a>Clean Up</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete all -l app=recommendation,version=v3
or
kubectl delete all -l app=recommendation,version=v3

istioctl delete -f istiofiles/destination-rule-recommendation-v1-v2-v3.yml -n tutorial
istioctl create -f istiofiles/virtual-service-promoted-v3.yml -n tutorial</code></pre>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <p></p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
